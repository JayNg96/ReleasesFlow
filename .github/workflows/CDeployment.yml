name: Deployment
on:
  push:
  pull_request: 
    types: [opened, closed]
    branches:
      - 'prod'
    
jobs:     
  build:
    runs-on: ubuntu-latest
    steps:
          
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          repository: JayNg96/ReleasesFlow   
          
      - name: Install Libraries
        run: |
          pip install flake8 pytest pytest-cov pandas Flask Flask-MySQLdb Flask-SQLAlchemy mysql-connector-python-rf PyMySQL SQLAlchemy
          
      - name: test with pytest
        run: |
          python -m pytest tests/test_* -v -cov --junitxml=report.xml
    
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action/composite@v2
        if: always()
        with:
          junit_files: "report.xml"
          
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: UAT
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to production
      if: github.event.pull_request.merged == true
      run: |
        git push origin prod
      # ansible-playbook deploy.yml -i production
      
    - name: Generate Release Version and Changelog
      run: |
        export RELEASE_VERSION=$(scripts/generate-version.sh)
        export CHANGELOG=$(scripts/generate-changelog.sh)
        
    - name: send zip on push
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          Hello Stakeholders,
          We are excited to announce the release of version ${{ env.RELEASE_VERSION }} of our project. ${{ env.CHANGELOG }}
          As always, if you have any questions or concerns, please don't hesitate to reach out to the project team.
          Best regards,
          DOT4"

